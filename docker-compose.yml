services:
  chat:
    build: .
    image: master-dissertation-code:latest
    env_file:
      - .env
    environment:
      # Optional override:
      # GROQ_MODEL: llama3-70b-8192
      HF_HOME: /cache/huggingface
      TRANSFORMERS_CACHE: /cache/huggingface/transformers
    volumes:
      # Thesis/Overleaf repo mounted read-only inside container
      - ../_local_repo/00-master-thesis-overleaf-help:/data:ro
      # Cache HF models so GPT-2 doesn't download every time
      - ./.cache:/cache
    stdin_open: true
    tty: true
    command: ["python", "01-context-extension-comparison/chat.py", "--context-file", "/data/Chapters/002Revision/Revision.tex"]

  test:
    build: .
    image: master-dissertation-code:latest
    environment:
      # Variáveis fake para testes (mocks não precisam de chave real)
      GROQ_API_KEY: fake-key-for-tests
      HF_HOME: /cache/huggingface
      TRANSFORMERS_CACHE: /cache/huggingface/transformers
    volumes:
      - ./.cache:/cache
    command: ["pytest", "tests/", "-v", "--tb=short"]

  # Benchmark completo (requer GROQ_API_KEY no .env)
  benchmark:
    build: .
    image: master-dissertation-code:latest
    env_file:
      - .env
    environment:
      HF_HOME: /cache/huggingface
      TRANSFORMERS_CACHE: /cache/huggingface/transformers
    volumes:
      - ./.cache:/cache
      - ./benchmark_results:/app/master-dissertation-code/benchmark_results
    command: ["python", "01-context-extension-comparison/run_benchmarks.py"]

  # Benchmark rápido (menos casos de teste)
  benchmark-quick:
    build: .
    image: master-dissertation-code:latest
    env_file:
      - .env
    environment:
      HF_HOME: /cache/huggingface
      TRANSFORMERS_CACHE: /cache/huggingface/transformers
    volumes:
      - ./.cache:/cache
      - ./benchmark_results:/app/master-dissertation-code/benchmark_results
    command: ["python", "01-context-extension-comparison/run_benchmarks.py", "--quick"]

  # Benchmark mock (sem API, para validar estrutura)
  benchmark-mock:
    build: .
    image: master-dissertation-code:latest
    environment:
      GROQ_API_KEY: not-needed-for-mock
      HF_HOME: /cache/huggingface
      TRANSFORMERS_CACHE: /cache/huggingface/transformers
    volumes:
      - ./.cache:/cache
      - ./benchmark_results:/app/master-dissertation-code/benchmark_results
    command: ["python", "01-context-extension-comparison/run_benchmarks.py", "--mock-only", "--quick"]
